<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Triforce</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#ffffff; --fg:#111827; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
      --th:#f3f4f6; --btn:#111827; --btnfg:#ffffff; --input:#ffffff;
      --shadow: 0 1px 2px rgba(0,0,0,.06);
      --link:#2563eb;
    }
    body.dark{
      --bg:#0b1220; --fg:#e5e7eb; --muted:#9ca3af; --card:#0f172a; --border:#24324a;
      --th:#111c33; --btn:#e5e7eb; --btnfg:#111827; --input:#0b1220;
      --shadow: 0 1px 2px rgba(0,0,0,.35);
      --link:#60a5fa;
    }

    body { font-family: system-ui, Arial; margin: 20px; background:var(--bg); color:var(--fg); }
    h1 { margin: 0 0 6px 0; }
    a { color: var(--link); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    input, select, button, textarea {
      padding:8px; font-size:14px; border:1px solid var(--border); border-radius:8px;
      background:var(--input); color:var(--fg);
    }
    button{
      border:1px solid var(--border);
      background:var(--btn); color:var(--btnfg);
      cursor:pointer;
      box-shadow: var(--shadow);
    }
    button.secondary{
      background: transparent; color: var(--fg);
    }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid var(--border); padding: 8px; vertical-align: top; }
    th { background: var(--th); text-align:left; }
    .card { border:1px solid var(--border); padding:12px; border-radius:12px; margin: 12px 0; background:var(--card); box-shadow: var(--shadow); }
    .mut { font-variant-numeric: tabular-nums; }
    .small { color:var(--muted); font-size:12px; }
    .topbar { display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap; }
    pre { margin:0; }
    details summary { cursor:pointer; }
  </style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1>Triforce</h1>
      <div class="small">PC-only Web-App (Supabase + Cloudflare Pages) â€¢ ASA (.ini) Import</div>
    </div>
    <div class="row" style="align-items:center;">
      <button id="btnTheme" class="secondary" title="Dark Mode umschalten">ðŸŒ™ Dark Mode</button>
    </div>
  </div>

  <div id="auth" class="card">
    <h2>Login</h2>
    <div class="row">
      <div>
        <div>Email</div>
        <input id="email" type="email" placeholder="name@mail.de"/>
      </div>
      <div>
        <div>Passwort</div>
        <input id="pw" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
      </div>
      <button id="btnLogin">Login</button>
      <button id="btnSignup" class="secondary">Registrieren</button>
      <button id="btnLogout" style="display:none;" class="secondary">Logout</button>
    </div>
    <div id="me" class="small" style="margin-top:8px;"></div>
  </div>

  <div id="app" style="display:none;">

    <div class="card">
      <h2>ASA Import (.ini)</h2>
      <div class="small">
        Datei aus: <code>...\ARK Survival Ascended\ShooterGame\Saved\DinoExports</code>
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="iniFile" type="file" accept=".ini" />
        <button id="btnImportIni">INI einlesen â†’ Formular fÃ¼llen</button>
      </div>
      <div id="importInfo" class="small" style="margin-top:8px;"></div>

      <details style="margin-top:10px;">
        <summary><b>Import-Details (Debug)</b> <span class="small">(hilft, wenn Farben/Level fehlen)</span></summary>
        <pre id="importDebug" style="white-space:pre-wrap; background:rgba(127,127,127,.08); padding:10px; border-radius:10px; border:1px solid var(--border); margin-top:10px;"></pre>
      </details>
    </div>

    <div class="card">
      <h2>Neuen Dino anlegen</h2>
      <div class="row">
        <div>
          <div>Spezies</div>
          <select id="species"></select>
        </div>
        <div>
          <div>Name</div>
          <input id="dname" placeholder="z.B. Rex HP-01"/>
        </div>
        <div>
          <div>Sex</div>
          <select id="sex">
            <option value="unknown">unknown</option>
            <option value="male">male</option>
            <option value="female">female</option>
          </select>
        </div>

        <div>
          <div>Level</div>
          <input id="lvl" type="number" min="1" placeholder="z.B. 141"/>
        </div>

        <div>
          <div>Status</div>
          <select id="status">
            <option value="unknown">unknown</option>
            <option value="breeder">breeder</option>
            <option value="reserve">reserve</option>
            <option value="retired">retired</option>
            <option value="baby">baby</option>
            <option value="egg">egg</option>
          </select>
        </div>
        <div class="mut">
          <div>Mut M</div>
          <input id="mutm" type="number" value="0" min="0"/>
        </div>
        <div class="mut">
          <div>Mut P</div>
          <input id="mutp" type="number" value="0" min="0"/>
        </div>
        <button id="btnCreate">Speichern</button>
      </div>

      <div style="margin-top:10px;">
        <details>
          <summary><b>Stats & Farben (optional)</b></summary>
          <div class="row" style="margin-top:10px;">
            <input id="hp" placeholder="Health"/>
            <input id="stam" placeholder="Stamina"/>
            <input id="oxy" placeholder="Oxygen"/>
            <input id="food" placeholder="Food"/>
            <input id="weight" placeholder="Weight"/>
            <input id="melee" placeholder="Melee"/>
            <input id="speed" placeholder="Speed"/>
          </div>
          <div class="row" style="margin-top:10px;">
            <input id="c0" placeholder="Region0 (id oder name)"/>
            <input id="c1" placeholder="Region1"/>
            <input id="c2" placeholder="Region2"/>
            <input id="c3" placeholder="Region3"/>
            <input id="c4" placeholder="Region4"/>
            <input id="c5" placeholder="Region5"/>
          </div>
        </details>
      </div>
    </div>

    <div class="card">
      <h2>Library</h2>
      <div class="row">
        <input id="q" placeholder="Suche Name/Tag..." />
        <button id="btnReload" class="secondary">Neu laden</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Spezies</th><th>Sex</th><th>Level</th><th>Status</th>
            <th>Mut (M/P/T)</th><th>Stats (HP / Melee / Wt)</th><th>Farben (R0..R5)</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
  // =========================
  // 1) SET THESE TWO VALUES:
  // =========================
  const SUPABASE_URL = "https://anxsdcmjknxgmdytrplf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFueHNkY21qa254Z21keXRycGxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNTM3ODgsImV4cCI6MjA4MTYyOTc4OH0.a8Es6bJaXfHDjXz2uwflDt7FMnQhWQN7X-LZe4voPIg";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const el = (id) => document.getElementById(id);

  // ---------- Dark Mode ----------
  function setTheme(isDark) {
    document.body.classList.toggle("dark", !!isDark);
    localStorage.setItem("triforce_theme", isDark ? "dark" : "light");
    el("btnTheme").textContent = isDark ? "â˜€ï¸ Light Mode" : "ðŸŒ™ Dark Mode";
  }
  (function initTheme(){
    const saved = localStorage.getItem("triforce_theme");
    setTheme(saved === "dark");
  })();
  el("btnTheme").onclick = () => setTheme(!document.body.classList.contains("dark"));

  // ---------- Auth / UI ----------
  async function refreshMe() {
    const { data: { user } } = await sb.auth.getUser();
    el("btnLogout").style.display = user ? "inline-block" : "none";
    el("app").style.display = user ? "block" : "none";
    el("me").textContent = user ? `Eingeloggt als: ${user.email}` : "Nicht eingeloggt.";
    if (user) {
      await loadSpecies();
      await loadLibrary();
    }
  }

  async function loadSpecies() {
    const { data, error } = await sb.from("species").select("*").order("name");
    if (error) { alert(error.message); return; }
    el("species").innerHTML = data.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
  }

  function parseNumber(v) {
    if (v === "" || v === null || v === undefined) return null;
    const n = Number(String(v).replace(",", "."));
    return Number.isFinite(n) ? n : null;
  }

  // -------- ASA .ini Import helpers --------
  function parseIni(text) {
    const sections = {};
    let current = "_";
    sections[current] = {};
    const lines = text.split(/\r?\n/);

    for (let raw of lines) {
      let line = raw.trim();
      if (!line) continue;
      if (line.startsWith(";") || line.startsWith("#")) continue;

      const sec = line.match(/^\[(.+?)\]$/);
      if (sec) {
        current = sec[1].trim();
        if (!sections[current]) sections[current] = {};
        continue;
      }

      const eq = line.indexOf("=");
      if (eq > 0) {
        const key = line.slice(0, eq).trim();
        const value = line.slice(eq + 1).trim();
        sections[current][key] = value;
      }
    }
    return sections;
  }

  function cleanStr(v) {
    if (v == null) return null;
    const s = String(v).trim();
    if (!s) return null;
    return s.replace(/^"(.*)"$/, "$1").trim();
  }

  function toInt(v) {
    if (v == null) return null;
    const m = String(v).match(/-?\d+/);
    if (!m) return null;
    const n = parseInt(m[0], 10);
    return Number.isFinite(n) ? n : null;
  }

  function toFloat(v) {
    if (v == null) return null;
    const s = String(v).replace(",", ".");
    const m = s.match(/-?\d+(\.\d+)?/);
    if (!m) return null;
    const n = parseFloat(m[0]);
    return Number.isFinite(n) ? n : null;
  }

  function toSex(v) {
    const s = (cleanStr(v) || "").toLowerCase();
    if (["male","mÃ¤nnlich","maennlich","m"].includes(s)) return "male";
    if (["female","weiblich","w"].includes(s)) return "female";
    // some exports use booleans/0/1
    if (s === "0" || s === "false") return "male";
    if (s === "1" || s === "true") return "female";
    return "unknown";
  }

  function getAny(sections, keys) {
    for (const key of keys) {
      for (const secName of Object.keys(sections)) {
        const sec = sections[secName];
        if (sec && Object.prototype.hasOwnProperty.call(sec, key)) {
          const val = cleanStr(sec[key]);
          if (val != null) return val;
        }
      }
    }
    return null;
  }

  function guessSpeciesFromValue(raw) {
    let v = cleanStr(raw);
    if (!v) return null;

    // if blueprint-like, take last part and remove suffix
    if (v.includes("/")) v = v.split("/").pop();
    // common ASA/ARK class pattern
    v = v.replace(/_Character_BP.*$/i, "");
    v = v.replace(/_BP.*$/i, "");
    v = v.replace(/_C$/i, "");
    v = v.replace(/BlueprintGeneratedClass/i, "").trim();

    // strip quotes again & weird punctuation
    v = v.replace(/[^a-zA-Z0-9 _-]/g, " ").trim();
    // collapse spaces
    v = v.replace(/\s+/g, " ");

    // if still huge, take first token
    if (v.length > 40) v = v.split(" ")[0];

    return v || null;
  }

  async function findSpeciesIdByBestMatch(name) {
    if (!name) return null;
    const want = name.trim().toLowerCase();
    const { data, error } = await sb.from("species").select("id,name");
    if (error) return null;

    // exact
    let hit = data.find(s => (s.name || "").trim().toLowerCase() === want);
    if (hit) return hit.id;

    // contains (either direction)
    hit = data.find(s => (s.name || "").toLowerCase().includes(want) || want.includes((s.name||"").toLowerCase()));
    return hit ? hit.id : null;
  }

  async function importAsaIni(file) {
    const text = await file.text();
    const ini = parseIni(text);

    // Debug output (sections + keys)
    const secNames = Object.keys(ini);
    let debug = "";
    for (const s of secNames) {
      const keys = Object.keys(ini[s] || {});
      debug += `[${s}] (${keys.length} keys)\n` + keys.slice(0, 220).join(", ") + "\n\n";
    }
    el("importDebug").textContent = debug.slice(0, 25000);

    // Name
    const dinoName =
      getAny(ini, ["DinoName","Name","CreatureName","TamedName","Dino Name","TamedNameString"]) ||
      file.name.replace(/\.ini$/i,"");

    // Species (tries multiple key families)
    const rawSpecies =
      getAny(ini, ["Species","DinoClass","ClassName","BlueprintPath","CreatureClass","DinoClassName","Blueprint","BP","Class"]);
    const speciesGuess = guessSpeciesFromValue(rawSpecies);

    // Sex
    const sex = toSex(getAny(ini, ["Sex","Gender","bIsFemale","IsFemale"]));

    // Level
    const lvl = toInt(getAny(ini, ["Level","DinoLevel","CharacterLevel","BaseLevel","CurrentLevel","MaxLevel"]));

    // Mutations
    const mutM = toInt(getAny(ini, [
      "MutationsMaternal","MutationMaternal","MutationCountMaternal","MatMut","MaternalMutations","MaternalMutationCount",
      "MotherMutations","MaternalMutation"
    ])) ?? 0;

    const mutP = toInt(getAny(ini, [
      "MutationsPaternal","MutationPaternal","MutationCountPaternal","PatMut","PaternalMutations","PaternalMutationCount",
      "FatherMutations","PaternalMutation"
    ])) ?? 0;

    // Stats (multiple naming variants; values may appear as current/max -> we take first number)
    const health = toFloat(getAny(ini, ["Health","StatHealth","BaseHealth","HP","HealthValue","HealthAmount"]));
    const stamina = toFloat(getAny(ini, ["Stamina","StatStamina","BaseStamina","Stam","StaminaValue","StaminaAmount"]));
    const oxygen = toFloat(getAny(ini, ["Oxygen","StatOxygen","BaseOxygen","Oxy","OxygenValue","OxygenAmount"]));
    const food = toFloat(getAny(ini, ["Food","StatFood","BaseFood","FoodValue","FoodAmount"]));
    const weight = toFloat(getAny(ini, ["Weight","StatWeight","BaseWeight","Wt","WeightValue","WeightAmount"]));
    const melee = toFloat(getAny(ini, ["Melee","MeleeDamage","StatMelee","BaseMelee","MeleeValue","MeleeDamagePercent"]));
    const speed = toFloat(getAny(ini, ["Speed","MovementSpeed","StatSpeed","BaseSpeed","SpeedValue","MovementSpeedPercent"]));

    // Colors (common patterns + indexed/array-style keys)
    const c0 = cleanStr(getAny(ini, ["ColorRegion0","Region0Color","Color0","Color0Id","Region0","ColorSetIndex0","ColorSetIndices0","ColorSetIndices[0]","Color0Name"]));
    const c1 = cleanStr(getAny(ini, ["ColorRegion1","Region1Color","Color1","Color1Id","Region1","ColorSetIndex1","ColorSetIndices1","ColorSetIndices[1]","Color1Name"]));
    const c2 = cleanStr(getAny(ini, ["ColorRegion2","Region2Color","Color2","Color2Id","Region2","ColorSetIndex2","ColorSetIndices2","ColorSetIndices[2]","Color2Name"]));
    const c3 = cleanStr(getAny(ini, ["ColorRegion3","Region3Color","Color3","Color3Id","Region3","ColorSetIndex3","ColorSetIndices3","ColorSetIndices[3]","Color3Name"]));
    const c4 = cleanStr(getAny(ini, ["ColorRegion4","Region4Color","Color4","Color4Id","Region4","ColorSetIndex4","ColorSetIndices4","ColorSetIndices[4]","Color4Name"]));
    const c5 = cleanStr(getAny(ini, ["ColorRegion5","Region5Color","Color5","Color5Id","Region5","ColorSetIndex5","ColorSetIndices5","ColorSetIndices[5]","Color5Name"]));

    // Fill form
    el("dname").value = dinoName || "";
    el("sex").value = sex || "unknown";
    el("mutm").value = String(mutM ?? 0);
    el("mutp").value = String(mutP ?? 0);
    el("lvl").value = (lvl != null) ? String(lvl) : "";

    // species select best match
    if (speciesGuess) {
      const sid = await findSpeciesIdByBestMatch(speciesGuess);
      if (sid) el("species").value = sid;
    }

    // stats
    if (health != null) el("hp").value = String(health);
    if (stamina != null) el("stam").value = String(stamina);
    if (oxygen != null) el("oxy").value = String(oxygen);
    if (food != null) el("food").value = String(food);
    if (weight != null) el("weight").value = String(weight);
    if (melee != null) el("melee").value = String(melee);
    if (speed != null) el("speed").value = String(speed);

    // colors
    if (c0 != null) el("c0").value = c0;
    if (c1 != null) el("c1").value = c1;
    if (c2 != null) el("c2").value = c2;
    if (c3 != null) el("c3").value = c3;
    if (c4 != null) el("c4").value = c4;
    if (c5 != null) el("c5").value = c5;

    // message
    const spTxt = speciesGuess ? `Spezies-Vorschlag: ${speciesGuess}` : "Spezies nicht erkannt";
    let msg = `INI geladen âœ“  Name: ${dinoName || "-"}  | ${spTxt}  | Level: ${lvl ?? "-"}  | Mut: ${mutM}/${mutP}  â†’ Jetzt nur noch â€žSpeichernâ€œ klicken.`;
    if (speciesGuess) {
      const sid = await findSpeciesIdByBestMatch(speciesGuess);
      if (!sid) msg += `  (Hinweis: Spezies "${speciesGuess}" ist noch nicht in Triforce â†’ Supabase â†’ species anlegen.)`;
    }
    el("importInfo").textContent = msg;
  }

  // ---------- Create Dino ----------
  async function createDino() {
    const { data: { user } } = await sb.auth.getUser();
    if (!user) return alert("Bitte einloggen.");

    const payload = {
      species_id: el("species").value,
      name: el("dname").value.trim(),
      sex: el("sex").value,
      level: parseInt(el("lvl").value || "", 10) || null,
      breeding_status: el("status").value,
      mut_maternal: parseInt(el("mutm").value || "0", 10),
      mut_paternal: parseInt(el("mutp").value || "0", 10),
      owner_id: user.id
    };
    if (!payload.name) return alert("Name fehlt.");

    const ins = await sb.from("creatures").insert(payload).select("id").single();
    if (ins.error) return alert(ins.error.message);
    const cid = ins.data.id;

    // stats optional
    const stats = {
      creature_id: cid,
      health: parseNumber(el("hp").value),
      stamina: parseNumber(el("stam").value),
      oxygen: parseNumber(el("oxy").value),
      food: parseNumber(el("food").value),
      weight: parseNumber(el("weight").value),
      melee: parseNumber(el("melee").value),
      speed: parseNumber(el("speed").value)
    };
    await sb.from("creature_stats").upsert(stats);

    // colors optional (store as name/id string for now)
    const colors = {
      creature_id: cid,
      region0_name: el("c0").value || null,
      region1_name: el("c1").value || null,
      region2_name: el("c2").value || null,
      region3_name: el("c3").value || null,
      region4_name: el("c4").value || null,
      region5_name: el("c5").value || null
    };
    await sb.from("creature_colors").upsert(colors);

    // clear a few fields
    el("dname").value = "";
    el("lvl").value = "";
    await loadLibrary();
    alert("Gespeichert.");
  }

  // ---------- Library ----------
  async function loadLibrary() {
    const q = el("q").value.trim().toLowerCase();

    const { data: creatures, error } = await sb
      .from("creatures")
      .select(`id,name,sex,level,breeding_status,mut_maternal,mut_paternal,tags,
              species:species_id(name),
              stats:creature_stats(health,melee,weight),
              colors:creature_colors(region0_name,region1_name,region2_name,region3_name,region4_name,region5_name)`)
      .order("created_at", { ascending: false })
      .limit(300);

    if (error) { alert(error.message); return; }

    const filtered = !q ? creatures : creatures.filter(c => {
      const tags = (c.tags || []).join(" ").toLowerCase();
      return (c.name || "").toLowerCase().includes(q) || tags.includes(q);
    });

    el("rows").innerHTML = filtered.map(c => {
      const m = c.mut_maternal ?? 0;
      const p = c.mut_paternal ?? 0;
      const t = m + p;

      const st = c.stats || {};
      const hp = st.health ?? "-";
      const ml = st.melee ?? "-";
      const wt = st.weight ?? "-";

      const col = c.colors || {};
      const cols = [col.region0_name,col.region1_name,col.region2_name,col.region3_name,col.region4_name,col.region5_name]
        .map(x => x || "-").join(" / ");

      return `<tr>
        <td>${c.name}</td>
        <td>${c.species?.name || "-"}</td>
        <td>${c.sex}</td>
        <td>${c.level ?? "-"}</td>
        <td>${c.breeding_status}</td>
        <td class="mut">${m} / ${p} / ${t}</td>
        <td>${hp} / ${ml} / ${wt}</td>
        <td>${cols}</td>
      </tr>`;
    }).join("");
  }

  // ---------- Buttons ----------
  el("btnLogin").onclick = async () => {
    const email = el("email").value.trim();
    const password = el("pw").value;
    const res = await sb.auth.signInWithPassword({ email, password });
    if (res.error) alert(res.error.message);
    await refreshMe();
  };

  el("btnSignup").onclick = async () => {
    const email = el("email").value.trim();
    const password = el("pw").value;
    const res = await sb.auth.signUp({ email, password });
    if (res.error) alert(res.error.message);
    else alert("Registriert. Wenn Email-BestÃ¤tigung aktiv ist: bitte Mail bestÃ¤tigen, dann einloggen.");
    await refreshMe();
  };

  el("btnLogout").onclick = async () => {
    await sb.auth.signOut();
    await refreshMe();
  };

  el("btnCreate").onclick = createDino;
  el("btnReload").onclick = loadLibrary;

  el("btnImportIni").onclick = async () => {
    const f = el("iniFile").files?.[0];
    if (!f) return alert("Bitte eine .ini Datei auswÃ¤hlen.");
    try {
      await importAsaIni(f);
    } catch (e) {
      console.error(e);
      alert("Import fehlgeschlagen. Ã–ffne 'Import-Details (Debug)' und schick mir die Key-Namen, dann passe ich es exakt an.");
    }
  };

  sb.auth.onAuthStateChange(() => refreshMe());
  refreshMe();
</script>
</body>
</html>
