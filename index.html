<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Triforce</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
      --th:#f3f4f6; --btn:#111827; --btnfg:#ffffff; --input:#f9fafb;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --link:#2563eb;
    }
    body.dark{
      --bg:#020617; --fg:#e5e7eb; --muted:#9ca3af; --card:#020617; --border:#1f2937;
      --th:#020617; --btn:#e5e7eb; --btnfg:#020617; --input:#020617;
      --shadow: 0 18px 45px rgba(0,0,0,.6);
      --link:#60a5fa;
    }

    *{ box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background:var(--bg);
      color:var(--fg);
    }

    .page {
      max-width: 1180px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 { margin: 0 0 4px 0; font-size: 26px; letter-spacing: 0.03em; }
    h2 { margin: 0 0 8px 0; font-size: 18px; }

    a { color: var(--link); }

    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    input, select, button, textarea {
      padding:8px 10px;
      font-size:14px;
      border:1px solid var(--border);
      border-radius:999px;
      background:var(--input);
      color:var(--fg);
      outline:none;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }
    input:focus, select:focus, textarea:focus {
      border-color:#6366f1;
      box-shadow:0 0 0 1px rgba(99,102,241,.4);
    }

    button{
      border:1px solid var(--border);
      background:var(--btn); color:var(--btnfg);
      cursor:pointer;
      box-shadow: var(--shadow);
      border-radius:999px;
      padding:8px 14px;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    button.secondary{
      background: transparent; color: var(--fg); box-shadow:none;
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
    }

    table { border-collapse: collapse; width: 100%; margin-top: 12px; border-radius:18px; overflow:hidden; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px 10px; vertical-align: top; font-size:13px; }
    th { background: var(--th); text-align:left; font-weight:600; font-size:12px; text-transform:uppercase; letter-spacing:.06em; }
    tbody tr:nth-child(even){ background: rgba(148,163,184,.08); }
    tbody tr:hover{ background: rgba(129,140,248,.12); }

    .card {
      border-radius:18px;
      margin: 14px 0;
      background: radial-gradient(circle at top left, rgba(59,130,246,.1), transparent 50%) , var(--card);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      padding:16px 16px 18px;
    }

    .mut { font-variant-numeric: tabular-nums; }

    .small { color:var(--muted); font-size:12px; }

    .topbar { display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap; margin-bottom:14px; }

    pre { margin:0; font-size:11px; }

    details summary { cursor:pointer; }

    .pill {
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
      gap:4px;
      background:rgba(15,23,42,.04);
    }
    body.dark .pill{ background:rgba(15,23,42,.7); }

    .pill-sex-male { color:#3b82f6; }
    .pill-sex-female { color:#ec4899; }
    .pill-status-breeder { color:#22c55e; }
    .pill-status-reserve { color:#eab308; }
    .pill-status-retired { color:#a855f7; }

    .layout-two {
      display:grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap:16px;
    }
    @media (max-width: 950px){
      .layout-two{ grid-template-columns: minmax(0,1fr); }
    }

    .color-swatches{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .color-chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:10px;
      background:rgba(15,23,42,.03);
    }
    body.dark .color-chip{
      background:rgba(15,23,42,.7);
    }
    .color-dot{
      width:14px;
      height:14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.35);
      box-shadow:0 0 0 1px rgba(255,255,255,.25);
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <div>
        <h1>Triforce</h1>
        <div class="small">Ark: Survival Ascended â€¢ Breeding &amp; Library â€¢ ASA (.ini) Import</div>
      </div>
      <div class="row" style="align-items:center;">
        <button id="btnTheme" class="secondary" title="Dark Mode umschalten">ðŸŒ™ Dark Mode</button>
      </div>
    </div>

    <div id="auth" class="card">
      <h2>Login</h2>
      <div class="row">
        <div>
          <div class="small">Email</div>
          <input id="email" type="email" placeholder="name@mail.de"/>
        </div>
        <div>
          <div class="small">Passwort</div>
          <input id="pw" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
        </div>
        <button id="btnLogin">Login</button>
        <button id="btnSignup" class="secondary">Registrieren</button>
        <button id="btnLogout" style="display:none;" class="secondary">Logout</button>
      </div>

      <div style="margin-top:10px;" class="row">
        <button id="btnDiscord" class="secondary" type="button">
          <span>Mit Discord einloggen</span>
        </button>
        <span class="small">OAuth von Supabase (Discord-Provider) â€“ kein Passwort nÃ¶tig.</span>
      </div>

      <div id="me" class="small" style="margin-top:8px;"></div>
    </div>

    <div id="app" style="display:none;">

      <div class="layout-two">
        <div class="card">
          <h2>ASA Import (.ini)</h2>
          <div class="small">
            Datei aus: <code>...\ARK Survival Ascended\ShooterGame\Saved\DinoExports</code>
          </div>
          <div class="row" style="margin-top:10px;">
            <input id="iniFile" type="file" accept=".ini" />
            <button id="btnImportIni">INI einlesen â†’ Formular fÃ¼llen</button>
          </div>
          <div id="importInfo" class="small" style="margin-top:8px;"></div>

          <details style="margin-top:10px;">
            <summary><b>Import-Details (Debug)</b> <span class="small">(hilft, wenn Farben/Level fehlen)</span></summary>
            <pre id="importDebug" style="white-space:pre-wrap; background:rgba(15,23,42,.04); padding:10px; border-radius:10px; border:1px solid var(--border); margin-top:10px;"></pre>
          </details>
        </div>

        <div class="card">
          <h2>Neuen Dino anlegen</h2>
          <div class="row">
            <div>
              <div class="small">Spezies</div>
              <select id="species"></select>
            </div>
            <div>
              <div class="small">Name</div>
              <input id="dname" placeholder="z.B. Rex HP-01"/>
            </div>
            <div>
              <div class="small">Sex</div>
              <select id="sex">
                <option value="unknown">unknown</option>
                <option value="male">male</option>
                <option value="female">female</option>
              </select>
            </div>

            <div>
              <div class="small">Level</div>
              <input id="lvl" type="number" min="1" placeholder="z.B. 141"/>
            </div>

            <div>
              <div class="small">Status</div>
              <select id="status">
                <option value="unknown">unknown</option>
                <option value="breeder">breeder</option>
                <option value="reserve">reserve</option>
                <option value="retired">retired</option>
                <option value="baby">baby</option>
                <option value="egg">egg</option>
              </select>
            </div>
            <div class="mut">
              <div class="small">Mut M</div>
              <input id="mutm" type="number" value="0" min="0"/>
            </div>
            <div class="mut">
              <div class="small">Mut P</div>
              <input id="mutp" type="number" value="0" min="0"/>
            </div>
          </div>

          <div style="margin-top:10px;">
            <details open>
              <summary><b>Stats &amp; Farben (optional)</b></summary>
              <div class="row" style="margin-top:10px;">
                <input id="hp" placeholder="Health"/>
                <input id="stam" placeholder="Stamina"/>
                <input id="oxy" placeholder="Oxygen"/>
                <input id="food" placeholder="Food"/>
                <input id="weight" placeholder="Weight"/>
                <input id="melee" placeholder="Melee"/>
                <input id="speed" placeholder="Speed"/>
              </div>
              <div class="row" style="margin-top:10px;">
                <input id="c0" placeholder="Region0 (RGBA / ID)"/>
                <input id="c1" placeholder="Region1"/>
                <input id="c2" placeholder="Region2"/>
                <input id="c3" placeholder="Region3"/>
                <input id="c4" placeholder="Region4"/>
                <input id="c5" placeholder="Region5"/>
              </div>
            </details>
          </div>

          <div style="margin-top:10px;">
            <button id="btnCreate">Dino speichern</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Library</h2>
        <div class="row">
          <input id="q" placeholder="Suche Name/Tag..." style="min-width:220px;"/>
          <button id="btnReload" class="secondary">Neu laden</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Name</th><th>Spezies</th><th>Sex</th><th>Level</th><th>Status</th>
              <th>Mut (M/P/T)</th><th>Stats (HP / Melee / Wt)</th><th>Farben</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

    </div>
  </div>

<script>
  // =========================
  // 1) HIER DEINE SUPABASE-DATEN EINTRAGEN:
  // =========================
  const SUPABASE_URL = "https://anxsdcmjknxgmdytrplf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFueHNkY21qa254Z21keXRycGxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNTM3ODgsImV4cCI6MjA4MTYyOTc4OH0.a8Es6bJaXfHDjXz2uwflDt7FMnQhWQN7X-LZe4voPIg";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const el = (id) => document.getElementById(id);

  // ---------- Dark Mode ----------
  function setTheme(isDark) {
    document.body.classList.toggle("dark", !!isDark);
    localStorage.setItem("triforce_theme", isDark ? "dark" : "light");
    el("btnTheme").textContent = isDark ? "â˜€ï¸ Light Mode" : "ðŸŒ™ Dark Mode";
  }
  (function initTheme(){
    const saved = localStorage.getItem("triforce_theme");
    setTheme(saved === "dark");
  })();
  el("btnTheme").onclick = () => setTheme(!document.body.classList.contains("dark"));

  // ---------- Auth / UI ----------
  async function refreshMe() {
    const { data: { user } } = await sb.auth.getUser();
    el("btnLogout").style.display = user ? "inline-block" : "none";
    el("app").style.display = user ? "block" : "none";
    el("me").textContent = user ? `Eingeloggt als: ${user.email}` : "Nicht eingeloggt.";
    if (user) {
      await loadSpecies();
      await loadLibrary();
    }
  }

  async function loadSpecies() {
    const { data, error } = await sb.from("species").select("*").order("name");
    if (error) { alert(error.message); return; }
    el("species").innerHTML = data.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
  }

  function parseNumber(v) {
    if (v === "" || v === null || v === undefined) return null;
    const n = Number(String(v).replace(",", "."));
    return Number.isFinite(n) ? n : null;
  }

  // -------- ASA .ini Import helpers --------
  function parseIni(text) {
    const sections = {};
    let current = "_";
    sections[current] = {};
    const lines = text.split(/\r?\n/);

    for (let raw of lines) {
      let line = raw.trim();
      if (!line) continue;
      if (line.startsWith(";") || line.startsWith("#")) continue;

      const sec = line.match(/^\[(.+?)\]$/);
      if (sec) {
        current = sec[1].trim();
        if (!sections[current]) sections[current] = {};
        continue;
      }

      const eq = line.indexOf("=");
      if (eq > 0) {
        const key = line.slice(0, eq).trim();
        const value = line.slice(eq + 1).trim();
        sections[current][key] = value;
      }
    }
    return sections;
  }

  function cleanStr(v) {
    if (v == null) return null;
    const s = String(v).trim();
    if (!s) return null;
    return s.replace(/^"(.*)"$/, "$1").trim();
  }

  function toInt(v) {
    if (v == null) return null;
    const m = String(v).match(/-?\d+/);
    if (!m) return null;
    const n = parseInt(m[0], 10);
    return Number.isFinite(n) ? n : null;
  }

  function toFloat(v) {
    if (v == null) return null;
    const s = String(v).replace(",", ".");
    const m = s.match(/-?\d+(\.\d+)?/);
    if (!m) return null;
    const n = parseFloat(m[0]);
    return Number.isFinite(n) ? n : null;
  }

  function toSex(v) {
    const s = (cleanStr(v) || "").toLowerCase();
    if (["male","mÃ¤nnlich","maennlich","m"].includes(s)) return "male";
    if (["female","weiblich","w"].includes(s)) return "female";
    if (s === "0" || s === "false") return "male";
    if (s === "1" || s === "true") return "female";
    return "unknown";
  }

  // case-insensitive Key-Suche
  function getAny(sections, keys) {
    for (const wanted of keys) {
      const wantedLower = wanted.toLowerCase();
      for (const secName of Object.keys(sections)) {
        const sec = sections[secName];
        if (!sec) continue;

        if (Object.prototype.hasOwnProperty.call(sec, wanted)) {
          const val = cleanStr(sec[wanted]);
          if (val != null) return val;
        }
        for (const actualKey of Object.keys(sec)) {
          if (actualKey.toLowerCase() === wantedLower) {
            const val = cleanStr(sec[actualKey]);
            if (val != null) return val;
          }
        }
      }
    }
    return null;
  }

  function guessSpeciesFromValue(raw) {
    let v = cleanStr(raw);
    if (!v) return null;

    if (v.includes("/")) v = v.split("/").pop();
    v = v.replace(/_Character_BP.*$/i, "");
    v = v.replace(/_BP.*$/i, "");
    v = v.replace(/_C$/i, "");
    v = v.replace(/BlueprintGeneratedClass/i, "").trim();
    v = v.replace(/[^a-zA-Z0-9 _-]/g, " ").trim();
    v = v.replace(/\s+/g, " ");
    if (v.length > 40) v = v.split(" ")[0];
    return v || null;
  }

  async function findSpeciesIdByBestMatch(name) {
    if (!name) return null;
    const want = name.trim().toLowerCase();
    const { data, error } = await sb.from("species").select("id,name");
    if (error) return null;

    let hit = data.find(s => (s.name || "").trim().toLowerCase() === want);
    if (hit) return hit.id;

    hit = data.find(s => (s.name || "").toLowerCase().includes(want) || want.includes((s.name||"").toLowerCase()));
    return hit ? hit.id : null;
  }

  function parseColorRGBA(str) {
    if (!str) return null;
    const m = str.match(/R=([0-9.]+).*G=([0-9.]+).*B=([0-9.]+)/i);
    if (!m) return null;
    const r = Math.round(parseFloat(m[1]) * 255);
    const g = Math.round(parseFloat(m[2]) * 255);
    const b = Math.round(parseFloat(m[3]) * 255);
    if (![r,g,b].every(n => Number.isFinite(n))) return null;
    return { r, g, b };
  }

  function renderColorSwatches(colorRow) {
    if (!colorRow) return "-";
    const vals = [
      colorRow.region0_name,
      colorRow.region1_name,
      colorRow.region2_name,
      colorRow.region3_name,
      colorRow.region4_name,
      colorRow.region5_name
    ];
    const labels = ["R0","R1","R2","R3","R4","R5"];

    const parts = [];
    for (let i=0;i<vals.length;i++) {
      const raw = vals[i];
      if (!raw) continue;
      const rgb = parseColorRGBA(raw);
      const preview = rgb
        ? `<span class="color-dot" style="background:rgb(${rgb.r},${rgb.g},${rgb.b});"></span>`
        : "";
      const shortText = rgb ? "" : (String(raw).slice(0,16) + (String(raw).length>16?"â€¦":""));
      parts.push(
        `<span class="color-chip">${preview}<span>${labels[i]}</span>${shortText ? `<span>${shortText}</span>` : ""}</span>`
      );
    }
    return parts.length ? `<div class="color-swatches">${parts.join(" ")}</div>` : "-";
  }

  async function importAsaIni(file) {
    const text = await file.text();
    const ini = parseIni(text);

    const secNames = Object.keys(ini);
    let debug = "";
    for (const s of secNames) {
      const keys = Object.keys(ini[s] || {});
      debug += `[${s}] (${keys.length} keys)\n` + keys.slice(0, 220).join(", ") + "\n\n";
    }
    el("importDebug").textContent = debug.slice(0, 25000);

        // Name: zuerst TamedName, dann DinoNameTag, sonst Dateiname
    const dinoName =
      getAny(ini, [
        "TamedName",        // dein gezÃ¤hmter Name
        "DinoNameTag",      // z.B. "Rex"
        "DinoName",
        "Name",
        "CreatureName",
        "Dino Name",
        "TamedNameString"
      ]) || file.name.replace(/\.ini$/i,"");

    // Spezies:
    // 1) zuerst NameTag/Species direkt verwenden (Rex, Spino, Pego ...)
    // 2) wenn das fehlt, Blueprint/Class zerlegen (â€¦Rex_Character_BP_C â†’ Rex)
    const speciesTag = getAny(ini, ["DinoNameTag","Species"]);
    let speciesGuess = speciesTag;
    if (!speciesGuess) {
      const rawSpecies =
        getAny(ini, ["DinoClass","ClassName","BlueprintPath","CreatureClass","DinoClassName","Blueprint","BP","Class"]);
      speciesGuess = guessSpeciesFromValue(rawSpecies);
    }


    const sex = toSex(getAny(ini, ["bIsFemale","Sex","Gender","IsFemale"]));

    const lvl = toInt(getAny(ini, ["CharacterLevel","Level","DinoLevel","BaseLevel","CurrentLevel","MaxLevel"]));

    const mutM = toInt(getAny(ini, [
      "RandomMutationsMale",
      "MutationsMaternal","MutationMaternal","MutationCountMaternal","MatMut",
      "MaternalMutations","MaternalMutationCount",
      "MotherMutations","MaternalMutation"
    ])) ?? 0;

    const mutP = toInt(getAny(ini, [
      "RandomMutationsFemale",
      "MutationsPaternal","MutationPaternal","MutationCountPaternal","PatMut",
      "PaternalMutations","PaternalMutationCount",
      "FatherMutations","PaternalMutation"
    ])) ?? 0;

    const health = toFloat(getAny(ini, ["Health","StatHealth","BaseHealth","HP","HealthValue","HealthAmount"]));
    const stamina = toFloat(getAny(ini, ["Stamina","StatStamina","BaseStamina","Stam","StaminaValue","StaminaAmount"]));
    const oxygen = toFloat(getAny(ini, ["Oxygen","StatOxygen","BaseOxygen","Oxy","OxygenValue","OxygenAmount"]));
    const food  = toFloat(getAny(ini, ["Food","food","StatFood","BaseFood","FoodValue","FoodAmount"]));
    const weight = toFloat(getAny(ini, ["Weight","StatWeight","BaseWeight","Wt","WeightValue","WeightAmount"]));
    const melee = toFloat(getAny(ini, [
      "Melee Damage","MeleeDamage","Melee",
      "StatMelee","BaseMelee","MeleeValue","MeleeDamagePercent"
    ]));
    const speed = toFloat(getAny(ini, [
      "Movement Speed","MovementSpeed","Speed",
      "StatSpeed","BaseSpeed","SpeedValue","MovementSpeedPercent"
    ]));

    const c0 = cleanStr(getAny(ini, [
      "ColorRegion0","Region0Color","Color0","Color0Id","Region0",
      "ColorSetIndex0","ColorSetIndices0","ColorSetIndices[0]",
      "Color0Name","ColorSet[0]"
    ]));
    const c1 = cleanStr(getAny(ini, [
      "ColorRegion1","Region1Color","Color1","Color1Id","Region1",
      "ColorSetIndex1","ColorSetIndices1","ColorSetIndices[1]",
      "Color1Name","ColorSet[1]"
    ]));
    const c2 = cleanStr(getAny(ini, [
      "ColorRegion2","Region2Color","Color2","Color2Id","Region2",
      "ColorSetIndex2","ColorSetIndices2","ColorSetIndices[2]",
      "Color2Name","ColorSet[2]"
    ]));
    const c3 = cleanStr(getAny(ini, [
      "ColorRegion3","Region3Color","Color3","Color3Id","Region3",
      "ColorSetIndex3","ColorSetIndices3","ColorSetIndices[3]",
      "Color3Name","ColorSet[3]"
    ]));
    const c4 = cleanStr(getAny(ini, [
      "ColorRegion4","Region4Color","Color4","Color4Id","Region4",
      "ColorSetIndex4","ColorSetIndices4","ColorSetIndices[4]",
      "Color4Name","ColorSet[4]"
    ]));
    const c5 = cleanStr(getAny(ini, [
      "ColorRegion5","Region5Color","Color5","Color5Id","Region5",
      "ColorSetIndex5","ColorSetIndices5","ColorSetIndices[5]",
      "Color5Name","ColorSet[5]"
    ]));

    el("dname").value = dinoName || "";
    el("sex").value = sex || "unknown";
    el("mutm").value = String(mutM ?? 0);
    el("mutp").value = String(mutP ?? 0);
    el("lvl").value = (lvl != null) ? String(lvl) : "";

    if (speciesGuess) {
      const sid = await findSpeciesIdByBestMatch(speciesGuess);
      if (sid) el("species").value = sid;
    }

    if (health != null) el("hp").value = String(health);
    if (stamina != null) el("stam").value = String(stamina);
    if (oxygen != null) el("oxy").value = String(oxygen);
    if (food != null) el("food").value = String(food);
    if (weight != null) el("weight").value = String(weight);
    if (melee != null) el("melee").value = String(melee);
    if (speed != null) el("speed").value = String(speed);

    if (c0 != null) el("c0").value = c0;
    if (c1 != null) el("c1").value = c1;
    if (c2 != null) el("c2").value = c2;
    if (c3 != null) el("c3").value = c3;
    if (c4 != null) el("c4").value = c4;
    if (c5 != null) el("c5").value = c5;

    const spTxt = speciesGuess ? `Spezies-Vorschlag: ${speciesGuess}` : "Spezies nicht erkannt";
    let msg = `INI geladen âœ“  Name: ${dinoName || "-"}  | ${spTxt}  | Level: ${lvl ?? "-"}  | Mut: ${mutM}/${mutP}  â†’ Jetzt nur noch â€žDino speichernâ€œ klicken.`;
    el("importInfo").textContent = msg;
  }

  // ---------- Create Dino ----------
  async function createDino() {
    const { data: { user } } = await sb.auth.getUser();
    if (!user) return alert("Bitte einloggen.");

    const payload = {
      species_id: el("species").value,
      name: el("dname").value.trim(),
      sex: el("sex").value,
      level: parseInt(el("lvl").value || "", 10) || null,
      breeding_status: el("status").value,
      mut_maternal: parseInt(el("mutm").value || "0", 10),
      mut_paternal: parseInt(el("mutp").value || "0", 10),
      owner_id: user.id
    };
    if (!payload.name) return alert("Name fehlt.");

    const ins = await sb.from("creatures").insert(payload).select("id").single();
    if (ins.error) return alert(ins.error.message);
    const cid = ins.data.id;

    const stats = {
      creature_id: cid,
      health: parseNumber(el("hp").value),
      stamina: parseNumber(el("stam").value),
      oxygen: parseNumber(el("oxy").value),
      food: parseNumber(el("food").value),
      weight: parseNumber(el("weight").value),
      melee: parseNumber(el("melee").value),
      speed: parseNumber(el("speed").value)
    };
    await sb.from("creature_stats").upsert(stats);

    const colors = {
      creature_id: cid,
      region0_name: el("c0").value || null,
      region1_name: el("c1").value || null,
      region2_name: el("c2").value || null,
      region3_name: el("c3").value || null,
      region4_name: el("c4").value || null,
      region5_name: el("c5").value || null
    };
    await sb.from("creature_colors").upsert(colors);

    el("dname").value = "";
    el("lvl").value = "";
    await loadLibrary();
    alert("Gespeichert.");
  }

  // ---------- Library ----------
  async function loadLibrary() {
    const q = el("q").value.trim().toLowerCase();

    const { data: creatures, error } = await sb
      .from("creatures")
      .select(`id,name,sex,level,breeding_status,mut_maternal,mut_paternal,tags,
              species:species_id(name),
              stats:creature_stats(health,melee,weight),
              colors:creature_colors(region0_name,region1_name,region2_name,region3_name,region4_name,region5_name)`)
      .order("created_at", { ascending: false })
      .limit(300);

    if (error) { alert(error.message); return; }

    const filtered = !q ? creatures : creatures.filter(c => {
      const tags = (c.tags || []).join(" ").toLowerCase();
      return (c.name || "").toLowerCase().includes(q) || tags.includes(q);
    });

    el("rows").innerHTML = filtered.map(c => {
      const m = c.mut_maternal ?? 0;
      const p = c.mut_paternal ?? 0;
      const t = m + p;

      const st = c.stats || {};
      const hp = st.health ?? "-";
      const ml = st.melee ?? "-";
      const wt = st.weight ?? "-";

      const col = c.colors || {};

      const sexClass = c.sex === "male" ? "pill-sex-male"
                        : c.sex === "female" ? "pill-sex-female"
                        : "";
      const statusClass = c.breeding_status === "breeder" ? "pill-status-breeder"
                        : c.breeding_status === "reserve" ? "pill-status-reserve"
                        : c.breeding_status === "retired" ? "pill-status-retired"
                        : "";

      return `<tr>
        <td>${c.name}</td>
        <td>${c.species?.name || "-"}</td>
        <td><span class="pill ${sexClass}">${c.sex}</span></td>
        <td>${c.level ?? "-"}</td>
        <td><span class="pill ${statusClass}">${c.breeding_status}</span></td>
        <td class="mut">${m} / ${p} / ${t}</td>
        <td>${hp} / ${ml} / ${wt}</td>
        <td>${renderColorSwatches(col)}</td>
      </tr>`;
    }).join("");
  }

  // ---------- Buttons ----------
  el("btnLogin").onclick = async () => {
    const email = el("email").value.trim();
    const password = el("pw").value;
    const res = await sb.auth.signInWithPassword({ email, password });
    if (res.error) alert(res.error.message);
    await refreshMe();
  };

  el("btnSignup").onclick = async () => {
    const email = el("email").value.trim();
    const password = el("pw").value;
    const res = await sb.auth.signUp({ email, password });
    if (res.error) alert(res.error.message);
    else alert("Registriert. Wenn Email-BestÃ¤tigung aktiv ist: bitte Mail bestÃ¤tigen, dann einloggen.");
    await refreshMe();
  };

  el("btnLogout").onclick = async () => {
    await sb.auth.signOut();
    await refreshMe();
  };

  // Discord-Login
  el("btnDiscord").onclick = async () => {
    try {
      const { error } = await sb.auth.signInWithOAuth({
        provider: "discord",
        options: { redirectTo: window.location.origin }
      });
      if (error) alert(error.message);
    } catch (e) {
      console.error(e);
      alert("Discord-Login fehlgeschlagen. Check in Supabase unter Authentication â†’ Providers â†’ Discord, ob alles korrekt ist.");
    }
  };

  el("btnCreate").onclick = createDino;
  el("btnReload").onclick = loadLibrary;

  el("btnImportIni").onclick = async () => {
    const f = el("iniFile").files?.[0];
    if (!f) return alert("Bitte eine .ini Datei auswÃ¤hlen.");
    try {
      await importAsaIni(f);
    } catch (e) {
      console.error(e);
      alert("Import fehlgeschlagen. Schau im Debug-Bereich nach, ob die Datei okay ist.");
    }
  };

  sb.auth.onAuthStateChange(() => refreshMe());
  refreshMe();
</script>
</body>
</html>
